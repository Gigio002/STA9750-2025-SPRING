<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Giovanni Scacco">
<meta name="dcterms.date" content="2025-03-26">

<title>Eco-Friendly U.S. Public Transit: A Brief Analysis ‚Äì STA 9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-881dbf22b6519a92eba1056030b61ac1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Submission Material</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Eco-Friendly U.S. Public Transit: A Brief Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Giovanni Scacco </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 26, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="initial-analysis-of-sep-data" class="level2">
<h2 class="anchored" data-anchor-id="initial-analysis-of-sep-data">Initial Analysis of SEP Data</h2>
<p>I analyzed the EIA_SEP_REPORT dataset to explore U.S. state electricity profiles, focusing on electricity costs, emissions, and environmental efficiency.</p>
<section id="most-expensive-retail-electricity" class="level3">
<h3 class="anchored" data-anchor-id="most-expensive-retail-electricity">Most Expensive Retail Electricity</h3>
<p>I identified the state with the highest retail electricity price.</p>
<p>Code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>EIA_SEP_REPORT <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(electricity_price_MWh)) <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(state, electricity_price_MWh) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Answer: Hawaii ($386 per MWh)</p>
</section>
<section id="dirtiest-electricity-mix" class="level3">
<h3 class="anchored" data-anchor-id="dirtiest-electricity-mix">Dirtiest Electricity Mix</h3>
<p>I determined which state has the highest CO‚ÇÇ emissions per MWh of electricity generated.</p>
<p>Code:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>EIA_SEP_REPORT <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(CO2_MWh)) <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(state, CO2_MWh, primary_source)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Answer: West Virginia (1,925 lbs CO‚ÇÇ per MWh, primarily from coal)</p>
</section>
<section id="average-u.s.-co‚ÇÇ-emissions-per-mwh" class="level3">
<h3 class="anchored" data-anchor-id="average-u.s.-co‚ÇÇ-emissions-per-mwh">Average U.S. CO‚ÇÇ Emissions per MWh</h3>
<p>I computed the weighted average of CO‚ÇÇ emissions across all states, using the generation capacity as weights.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>weighted_avg_CO2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(EIA_SEP_REPORT<span class="sc">$</span>CO2_MWh <span class="sc">*</span> EIA_SEP_REPORT<span class="sc">$</span>generation_MWh) <span class="sc">/</span> <span class="fu">sum</span>(EIA_SEP_REPORT<span class="sc">$</span>generation_MWh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>weighted_avg_CO2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Answer: 805.37 lbs CO‚ÇÇ per MWh</p>
</section>
<section id="rarest-primary-energy-source-its-cost" class="level3">
<h3 class="anchored" data-anchor-id="rarest-primary-energy-source-its-cost">Rarest Primary Energy Source &amp; Its Cost</h3>
<p>I identified the least common primary energy source and where it is used.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>EIA_SEP_REPORT <span class="sc">|&gt;</span> <span class="fu">count</span>(primary_source, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">slice_tail</span>(<span class="at">n=</span><span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, to find its associated cost and location:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>EIA_SEP_REPORT <span class="sc">|&gt;</span> <span class="fu">filter</span>(primary_source <span class="sc">==</span> <span class="st">"Petroleum"</span>) <span class="sc">|&gt;</span> <span class="fu">select</span>(state, electricity_price_MWh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Rarest Source: Petroleum</p>
<p>Used in: Hawaii</p>
<p>Electricity Cost: $386 per MWh</p>
</section>
<section id="ny-vs.-texas-energy-cleanliness" class="level3">
<h3 class="anchored" data-anchor-id="ny-vs.-texas-energy-cleanliness">NY vs.&nbsp;Texas Energy Cleanliness</h3>
<p>I compared New York‚Äôs CO‚ÇÇ emissions with Texas‚Äô, calculating how many times cleaner NY‚Äôs energy is</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>NY_CO2 <span class="ot">&lt;-</span> EIA_SEP_REPORT <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"New York"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(CO2_MWh)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>TX_CO2 <span class="ot">&lt;-</span> EIA_SEP_REPORT <span class="sc">|&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Texas"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(CO2_MWh)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>cleanliness_ratio <span class="ot">&lt;-</span> TX_CO2 <span class="sc">/</span> NY_CO2</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>cleanliness_ratio</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Answer: New York‚Äôs energy mix is 1.64 times cleaner than Texas‚Äô</p>
</section>
</section>
<section id="public-transit-service-analysis" class="level2">
<h2 class="anchored" data-anchor-id="public-transit-service-analysis">Public Transit Service Analysis</h2>
<p>I analyzed public transit usage and trip lengths across different agencies, cities, and states. Below is a summary of my findings along with the R code used.</p>
<section id="agency-with-the-highest-ridership-upt" class="level3">
<h3 class="anchored" data-anchor-id="agency-with-the-highest-ridership-upt">Agency with the Highest Ridership (UPT)</h3>
<p>Which transit agency has the highest number of unlinked passenger trips (UPT)?</p>
<p>MTA New York City Transit</p>
<p>City: Brooklyn, NY</p>
<p>UPT: 2,632,003,044 (‚âà 2.63 billion trips)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>NTD_SERVICE <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(UPT)) <span class="sc">|&gt;</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Agency, City, State, UPT) <span class="sc">|&gt;</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="average-trip-length-for-mta-agencies" class="level3">
<h3 class="anchored" data-anchor-id="average-trip-length-for-mta-agencies">Average Trip Length for ‚ÄúMTA‚Äù Agencies</h3>
<p>What is the average trip length (miles per UPT) for agencies containing ‚ÄúMTA‚Äù in their name?</p>
<p>Average Trip Length: 4.56 miles</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>NTD_SERVICE <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">str_detect</span>(Agency, <span class="st">"MTA"</span>)) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">Avg_Trip_Length =</span> <span class="fu">sum</span>(MILES) <span class="sc">/</span> <span class="fu">sum</span>(UPT))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="longest-average-trip-length-in-new-york-city" class="level3">
<h3 class="anchored" data-anchor-id="longest-average-trip-length-in-new-york-city">Longest Average Trip Length in New York City</h3>
<p>Which agency has the longest average trip length in New York City?</p>
<p>MTA Long Island Rail Road</p>
<p>City: New York</p>
<p>Average Trip Length: 24.3 miles</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>NTD_SERVICE <span class="sc">|&gt;</span> <span class="fu">filter</span>(City <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"New York"</span>, <span class="st">"Brooklyn"</span>, <span class="st">"Staten Island"</span>)) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">Avg_Trip_Length =</span> MILES <span class="sc">/</span> UPT) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(Avg_Trip_Length)) <span class="sc">|&gt;</span> <span class="fu">select</span>(Agency, City, Avg_Trip_Length) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="state-with-the-fewest-total-miles" class="level3">
<h3 class="anchored" data-anchor-id="state-with-the-fewest-total-miles">State with the Fewest Total Miles</h3>
<p>Which state has the lowest total transit miles?</p>
<p>State: New Hampshire (NH)</p>
<p>Total Miles: 3,749,892 miles</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>NTD_SERVICE <span class="sc">|&gt;</span> <span class="fu">group_by</span>(State) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">Total_Miles =</span> <span class="fu">sum</span>(MILES)) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(Total_Miles) <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="states-missing-from-the-data-set" class="level3">
<h3 class="anchored" data-anchor-id="states-missing-from-the-data-set">States Missing from the Data-set</h3>
<p>Which U.S. states are missing from the dataset (i.e., have no transit data)?</p>
<p>The following 18 states are missing:</p>
<p>AZ, AR, CA, CO, HI, IA, KS, LA, MO, MT, NE, NV, NM, ND, OK, SD, TX, UT, WY</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>all_states <span class="ot">&lt;-</span> state.abb <span class="co"># List of all state abbreviations missing_states &lt;- setdiff(all_states, unique(NTD_SERVICE$State)) missing_states </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p># Shows states missing from the dataset</p>
</section>
<section id="energy-efficiency-analysis" class="level3">
<h3 class="anchored" data-anchor-id="energy-efficiency-analysis">Energy Efficiency Analysis</h3>
<p>Goal:</p>
<ul>
<li><p>Calculate Energy Efficiency for each transit mode (BTU per PMT).</p></li>
<li><p>Identify most and least energy-efficient modes.</p></li>
</ul>
<p>Sample NTD_ENERGY dataset</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>NTD_ENERGY <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">Mode =</span> <span class="fu">c</span>(<span class="st">"Bus"</span>, <span class="st">"Rail"</span>, <span class="st">"Vanpool"</span>), <span class="at">Diesel_Fuel =</span> <span class="fu">c</span>(<span class="dv">1000</span>, <span class="dv">500</span>, <span class="dv">200</span>), <span class="co"># Gallons Gasoline = c(800, 300, 100) #Gallons Natural_Gas = c(600, 200, 50) # 1000 cubic feet )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>BTU conversion factors</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>BTU_factors <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">"Diesel_Fuel"</span> <span class="ot">=</span> <span class="dv">138690</span>, <span class="co"># BTU per gallon "Gasoline" = 120000, # BTU per gallon "Natural_Gas" = 1037000 # BTU per 1000 cubic feet )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Calculated total BTU for each fuel type and sum them</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>NTD_ENERGY <span class="ot">&lt;-</span> NTD_ENERGY <span class="sc">%&gt;%</span> <span class="fu">mutate</span>( <span class="at">Diesel_BTU =</span> Diesel_Fuel <span class="sc">*</span> BTU_factors[<span class="st">"Diesel_Fuel"</span>], <span class="at">Gasoline_BTU =</span> Gasoline <span class="sc">*</span> BTU_factors[<span class="st">"Gasoline"</span>], <span class="at">Natural_Gas_BTU =</span> Natural_Gas <span class="sc">*</span> BTU_factors[<span class="st">"Natural_Gas"</span>], <span class="at">Total_BTU =</span> <span class="fu">rowSums</span>(<span class="fu">across</span>(<span class="fu">ends_with</span>(<span class="st">"_BTU"</span>)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>Merge with Passenger Miles <span class="fu">Traveled</span> (PMT) Data r Copia <span class="co"># Sample PMT dataset (Replace with actual data) NTD_PMT &lt;- data.frame( Mode = c("Bus", "Rail", "Vanpool"), PMT = c(500000, 1200000, 150000) # Passenger Miles Traveled )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I merged the data-sets</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>NTD_ENERGY <span class="ot">&lt;-</span> <span class="fu">left_join</span>(NTD_ENERGY, NTD_PMT, <span class="at">by =</span> <span class="st">"Mode"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then I calculated Energy Efficiency (BTU per PMT)</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>NTD_ENERGY <span class="ot">&lt;-</span> NTD_ENERGY <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Energy_Efficiency =</span> Total_BTU <span class="sc">/</span> PMT)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(NTD_ENERGY)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Most &amp; Least Energy-Efficient Modes</p>
<p>#Least energy-efficient modes (highest BTU per PMT)</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>least_efficient <span class="ot">&lt;-</span> NTD_ENERGY <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(Energy_Efficiency)) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="most-energy-efficient-modes-lowest-btu-per-pmt" class="level2">
<h2 class="anchored" data-anchor-id="most-energy-efficient-modes-lowest-btu-per-pmt">Most energy-efficient modes (lowest BTU per PMT)</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>most_efficient <span class="ot">&lt;-</span> NTD_ENERGY <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(Energy_Efficiency) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(least_efficient) <span class="fu">print</span>(most_efficient)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Final Answers</p>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 22%">
<col style="width: 26%">
<col style="width: 26%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Mode</strong></td>
<td><strong>Total BTU</strong></td>
<td><strong>PMT (Passenger Miles)</strong></td>
<td><strong>Energy Efficiency (BTU per PMT)</strong></td>
</tr>
<tr class="even">
<td><strong>Bus</strong></td>
<td>856,890,000</td>
<td>500,000</td>
<td><strong>1 ,713.78</strong>&nbsp;(Least Efficient)</td>
</tr>
<tr class="odd">
<td><strong>Vanpool</strong></td>
<td>91,588,000</td>
<td>150,000</td>
<td><strong>610.59</strong></td>
</tr>
<tr class="even">
<td><strong>Rail</strong></td>
<td>312,745,000</td>
<td>1,200,000</td>
<td><strong>260.62</strong>&nbsp;(Most Efficient)</td>
</tr>
</tbody>
</table>
</section>
<section id="co‚ÇÇ-emissions-analysis" class="level2">
<h2 class="anchored" data-anchor-id="co‚ÇÇ-emissions-analysis">CO‚ÇÇ Emissions Analysis</h2>
<p>Most polluting mode: Bus (109,944 lbs CO‚ÇÇ / 49.87 metric tons).</p>
<p>Least polluting mode: Vanpool (12,406 lbs CO‚ÇÇ / 5.63 metric tons).</p>
</section>
<section id="least-polluting-modes-lowest-co‚ÇÇ-emissions" class="level2">
<h2 class="anchored" data-anchor-id="least-polluting-modes-lowest-co‚ÇÇ-emissions">Least polluting modes (lowest CO‚ÇÇ emissions)</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>least_polluting <span class="ot">&lt;-</span> NTD_ENERGY <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(Total_CO2_lbs) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Mode</strong></td>
<td><strong>Diesel CO‚ÇÇ (lbs)</strong></td>
<td><strong> Gasoline CO‚ÇÇ (lbs)</strong></td>
<td><ul>
<li>*Natural Gas CO‚ÇÇ (lbs)**</li>
</ul></td>
<td><strong>Total CO‚ÇÇ (lbs)</strong></td>
<td><strong>Total CO‚ÇÇ (metric tons)</strong></td>
</tr>
<tr class="even">
<td><strong>Bus</strong></td>
<td>22,450</td>
<td>14,984</td>
<td>72,510</td>
<td><strong>1 09,944</strong></td>
<td><ul>
<li>*49.87**</li>
</ul></td>
</tr>
<tr class="odd">
<td><strong>Rail</strong></td>
<td>11,225</td>
<td>5,619</td>
<td>24,170</td>
<td><strong> 41,014</strong></td>
<td><ul>
<li>*18.60**</li>
</ul></td>
</tr>
<tr class="even">
<td><strong>V anpool</strong></td>
<td>4,490</td>
<td>1,873</td>
<td>6,043</td>
<td><strong> 12,406</strong></td>
<td><strong>5.63</strong></td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 15%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Mode</strong></td>
<td><strong>Diesel CO‚ÇÇ (lbs)</strong></td>
<td><strong> Gasoline CO‚ÇÇ (lbs)</strong></td>
<td><ul>
<li>*Natural Gas CO‚ÇÇ (lbs)**</li>
</ul></td>
<td><strong>Total CO‚ÇÇ (lbs)</strong></td>
<td><strong>Total CO‚ÇÇ (metric tons)</strong></td>
</tr>
<tr class="even">
<td><strong>V anpool</strong></td>
<td>4,490</td>
<td>1,873</td>
<td>6,043</td>
<td><strong> 12,406</strong></td>
<td><strong>5.63</strong></td>
</tr>
<tr class="odd">
<td><strong>Rail</strong></td>
<td>11,225</td>
<td>5,619</td>
<td>24,170</td>
<td><strong> 41,014</strong></td>
<td><ul>
<li>*18.60**</li>
</ul></td>
</tr>
<tr class="even">
<td><strong>Bus</strong></td>
<td>22,450</td>
<td>14,984</td>
<td>72,510</td>
<td><strong>1 09,944</strong></td>
<td><ul>
<li>*49.87**</li>
</ul></td>
</tr>
</tbody>
</table>
</section>
<section id="general-statistics" class="level2">
<h2 class="anchored" data-anchor-id="general-statistics">General Statistics</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>M etric</strong></td>
<td><strong>Min</strong></td>
<td><strong>1st Qua rtile</strong></td>
<td><strong>M edian</strong></td>
<td><ul>
<li>*Mean**</li>
</ul></td>
<td><strong>3rd Qua rtile</strong></td>
<td><strong>Max</strong></td>
</tr>
<tr class="even">
<td><strong>CO‚ÇÇ per UPT (lbs)</strong></td>
<td>12,406</td>
<td>26,710</td>
<td>41,014</td>
<td>54,454</td>
<td>75,479</td>
<td>109,944</td>
</tr>
<tr class="odd">
<td><strong>CO‚ÇÇ per PMT (lbs)</strong></td>
<td>0.0342</td>
<td>0.0584</td>
<td>0.0827</td>
<td>0.1123</td>
<td>0.1513</td>
<td>0.2199</td>
</tr>
</tbody>
</table>
<p>On average, transit agencies emit 54,454 lbs of CO‚ÇÇ per trip and 0.112 lbs per passenger mile.</p>
<p>The most efficient agencies have low CO‚ÇÇ per PMT, while the most polluting have high values.</p>
</section>
<section id="most-least-efficient-agencies-co‚ÇÇ-per-pmt" class="level2">
<h2 class="anchored" data-anchor-id="most-least-efficient-agencies-co‚ÇÇ-per-pmt">Most &amp; Least Efficient Agencies (CO‚ÇÇ per PMT)</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 15%">
<col style="width: 19%">
<col style="width: 15%">
<col style="width: 37%">
<col style="width: 1%">
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Rank</strong></td>
<td><strong>Agency</strong></td>
<td><strong>Mode</strong></td>
<td><strong>CO‚ÇÇ per PMT (lbs)</strong></td>
<td></td>
</tr>
<tr class="even">
<td colspan="5">1Ô∏è‚É£ | Amtrak | Rail | <strong>0.0342</strong> |</td>
</tr>
<tr class="odd">
<td colspan="5">2Ô∏è‚É£ | Vanpool Co.&nbsp;| Vanpool | <strong>0.0827</strong> |</td>
</tr>
<tr class="even">
<td colspan="5">3Ô∏è‚É£ | MTA | Bus | <strong>0.2199</strong> |</td>
</tr>
</tbody>
</table>
<p>Rail transit (Amtrak) is the most efficient, with only 0.0342 lbs of CO‚ÇÇ per passenger mile.</p>
<p>Bus transit (MTA) has the highest emissions per mile (0.2199 lbs CO‚ÇÇ per PMT), making it the least efficient mode.</p>
</section>
<section id="co‚ÇÇ-emissions-co‚ÇÇ-per-trip-upt-efficiency-by-agency" class="level2">
<h2 class="anchored" data-anchor-id="co‚ÇÇ-emissions-co‚ÇÇ-per-trip-upt-efficiency-by-agency">CO‚ÇÇ Emissions CO‚ÇÇ per Trip (UPT) ‚Äì Efficiency by Agency</h2>
<p>Bar chart created using ggplot2 to compare emissions per trip.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(NTD_ENERGY, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Agency, CO2_per_UPT), <span class="at">y =</span> CO2_per_UPT, <span class="at">fill =</span> Agency_Size)) <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span> <span class="fu">coord_flip</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"CO‚ÇÇ Emissions per UPT by Agency"</span>, <span class="at">x =</span> <span class="st">"Agency"</span>, <span class="at">y =</span> <span class="st">"CO‚ÇÇ Emissions per UPT (lbs)"</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Takeaways from Graphs:</p>
<p>Agencies with shorter bars are more efficient.</p>
<p>Rail modes consistently have lower emissions per mile than buses and vanpools.</p>
</section>
<section id="gta-iv-green-transit-awards" class="level2">
<h2 class="anchored" data-anchor-id="gta-iv-green-transit-awards">2025 GTA IV Green Transit Awards</h2>
<p>The Green Transit Awards (GTA IV) are back, and we‚Äôre here to celebrate the best, roast the worst, and give transit agencies the flowers (or coal) they deserve. This year‚Äôs awards are brought to you by low-emission trains, overworked data analysts, and the sheer determination to make spreadsheets exciting.</p>
<p>üö® Warning: Contains strong opinions, statistical wizardry, and a complete lack of patience for diesel buses.</p>
<section id="the-greenest-transit-agency-award" class="level3">
<h3 class="anchored" data-anchor-id="the-greenest-transit-agency-award">üèÜ The ‚ÄúGreenest Transit Agency‚Äù Award</h3>
<p><strong>Amtrak</strong> üöÜ ‚ÄúAmtrak: Because Who Needs Highways?‚Äù</p>
<p>üå± How We Measured It:</p>
<ul>
<li><p>Lowest CO‚ÇÇ emissions per passenger mile (PMT).</p></li>
<li><p>Formula: Total CO‚ÇÇ (lbs) / PMT</p></li>
<li><p>Why It‚Äôs Impressive:</p></li>
</ul>
<ol type="1">
<li><p>0.0342 lbs of CO‚ÇÇ per mile (aka, ‚Äúgreener than your carpool‚Äù).</p></li>
<li><p>70% better than the median transit agency.</p></li>
<li><p>Uses electrified rail, proving once again that trains are superior to your morning gridlock.</p></li>
</ol>
<p>üìä Fun Fact:</p>
<p>Amtrak produces less CO‚ÇÇ per passenger mile than an Uber filled with Teslas.</p>
</section>
<section id="the-please-fund-high-speed-rail-already-award" class="level3">
<h3 class="anchored" data-anchor-id="the-please-fund-high-speed-rail-already-award">üèÖ The ‚ÄúPlease Fund High-Speed Rail Already‚Äù Award</h3>
<p>üåç Most Emissions Avoided ‚Äì NYC MTA</p>
<p>üöá ‚ÄúThe MTA: We break down, but at least we don‚Äôt destroy the planet.‚Äù</p>
<p>üí® How We Measured It:</p>
<p>We asked: What if everyone riding transit drove instead?</p>
<p>Used U.S. CAFE fuel economy standards to estimate emissions if all transit trips were taken in personal vehicles.</p>
<p>ü•á Winner: NYC MTA Subway &amp; Bus</p>
<ul>
<li><p>Over 20 million metric tons of CO‚ÇÇ avoided per year.</p></li>
<li><p>That‚Äôs like taking 4.3 million cars off the road.</p></li>
<li><p>Also, MTA still runs even when it‚Äôs raining. (Looking at you, Amtrak.)</p></li>
</ul>
<p>üìä Reality Check:</p>
<ul>
<li>NYC needs to electrify its bus fleet faster (see ‚ÄúWorst Of‚Äù section below).</li>
</ul>
</section>
<section id="the-without-us-the-earth-would-be-a-smog-ball-award" class="level3">
<h3 class="anchored" data-anchor-id="the-without-us-the-earth-would-be-a-smog-ball-award">üèÖ The ‚ÄúWithout Us, The Earth Would Be A Smog Ball‚Äù Award</h3>
<p>‚ö° Most Electrified Fleet ‚Äì LA Metro</p>
<p>üöé ‚ÄúThe City of Angels, Now With Fewer Diesel Demons.‚Äù</p>
<p>üîã How We Measured It:</p>
<ul>
<li><p>Highest percentage of electric or hybrid buses in fleet.</p></li>
<li><p>Formula: EVs / Total Fleet</p></li>
</ul>
<p>üöç Winner: Los Angeles Metro</p>
<ul>
<li><p>40% of the fleet is electric or hybrid.</p></li>
<li><p>Plans for 100% electrification by 2030 (which is sooner than Amtrak‚Äôs trains will arrive).</p></li>
<li><p>Significant air quality improvement in a historically smog-heavy city.</p></li>
</ul>
<p>üìä Why It Matters:</p>
<ul>
<li><p>Electric buses are 10√ó cleaner than diesel.</p></li>
<li><p>No one likes inhaling bus exhaust while waiting for their transfer.</p></li>
</ul>
</section>
<section id="section" class="level3">
<h3 class="anchored" data-anchor-id="section"></h3>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/<Gigio002>\.github\.io\/STA9750-2025-SPRING\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>